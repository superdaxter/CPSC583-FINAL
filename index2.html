<!DOCTYPE html>
<style>
    .state-borders {
        fill: none;
        stroke: black;
        stroke-width: 1px;
        stroke-linejoin: round;
        stroke-linecap: round;
        pointer-events: none;
    }
</style>

<head>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.js"
        integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
</head>

<body>
    <div id="header"></div>
    <div>
        <h1 style="text-align: center;">CPSC 583 - Data Visualization 2</h1>
    </div>

    <div class="row">
        <div class="col-8">
            <svg width="960" height="600" style="display: block; margin: auto;"></svg>
        </div>
        <div class="col align-self-center">
            <h3>Breach Types</h3>
            <svg id="chart">
            </svg>
        </div>
    </div>


    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <!-- Map Visual -->
    <script>

        //Array for Individuals Affected (SUM)
        var personsAffectedArray = {
        }

        //Summation data for Type of Breach etc.
        let BreachTypeSumData = [
            { breach: "Hack", freq: 0, color: "yellow" },
            { breach: "UA", freq: 0, color: "green" },
            { breach: "Theft", freq: 0, color: "black" },
            { breach: "Other", freq: 0, color: "red" },
            { breach: "ImD", freq: 0, color: "purple" },
            { breach: "Loss", freq: 0, color: "silver" },
            { breach: "Unknown", freq: 0, color: "pink" }
        ]

        /* console.log(BreachTypeSumData) */

        var svg = d3.select("svg");
        var path = d3.geoPath();
        d3.json("states.json", function (error, us) {
            if (error) throw error;

            /* console.log(us) */

            //Load my data first
            d3.json("myData-All.json", function (data) {
                //Calculate the total Affected per State
                //Add the data to total Data
                data.forEach(function (d) {
                    if (d.State in personsAffectedArray) {
                        personsAffectedArray[d.State] += +d.Individuals_Affected;
                    } else {
                        personsAffectedArray[d.State] = +d.Individuals_Affected;
                    }
                    //total data
                    if (d.Type_of_Breach.includes("Hack")) {
                        BreachTypeSumData[0].freq++
                    }
                    if (d.Type_of_Breach.includes("Unauthorized")) {
                        BreachTypeSumData[1].freq++
                    }
                    if (d.Type_of_Breach.includes("Theft")) {
                        BreachTypeSumData[2].freq++
                    }
                    if (d.Type_of_Breach.includes("Other")) {
                        BreachTypeSumData[3].freq++
                    }
                    if (d.Type_of_Breach.includes("Improper Disposal")) {
                        BreachTypeSumData[4].freq++
                    }
                    if (d.Type_of_Breach.includes("Loss")) {
                        BreachTypeSumData[5].freq++
                    }
                    if (d.Type_of_Breach.includes("Unknown")) {
                        BreachTypeSumData[6].freq++
                    }
                })

                //Move this to just after Numbers are done calculating
                /* Bar Chart Visual */
                //Margins
                var margin = { top: 20, right: 20, bottom: 30, left: 40 },
                    width = 480 - margin.left - margin.right,
                    height = 250 - margin.bottom - margin.top;

                //Ranges
                /* .domain(["Hack", "UA", "Theft", "Other", "ImD", "Loss", "Unknown"]) */
                var x = d3.scaleBand()
                    .range([0, width])
                    .padding(0.2);

                var y = d3.scaleLinear()
                    .range([height, 0]);

                var svgChart = d3.select('#chart')
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.right + ")");

                //Retrieve Chart Data
                var min = 100000000;
                var max = 0;
                for (i = 0; i < BreachTypeSumData.length; i++) {
                    if (BreachTypeSumData[i].freq < min) {
                        min = BreachTypeSumData[i].freq;
                    }
                    if (BreachTypeSumData[i].freq > max) {
                        max = BreachTypeSumData[i].freq;
                    }
                }

                console.log("max " + max)
                console.log("min " + min)

                x.domain(BreachTypeSumData.map(function (d) {
                    return d.breach;
                }))

                //Domains
                y.domain([0, d3.max(BreachTypeSumData, function (d) {
                    return d.freq
                })])

                svgChart.selectAll("rect")
                    .data(BreachTypeSumData)
                    .enter()
                    .append("rect")
                    .attr("class", "bar")
                    .attr("x", function (d) {
                        return x(d.breach)
                    })
                    .attr("width", x.bandwidth())
                    .attr("y", function (d) {
                        return y(d.freq)
                    })
                    .attr("height", function (d) {
                        return height - y(d.freq)
                    });

                svgChart.selectAll("rect")
                    .data(BreachTypeSumData)
                    .attr("fill", function (d) {
                        return d.color;
                    })


                svgChart.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x));

                svgChart.append("g")
                    .call(d3.axisLeft(y));

                //Colors for amount of people affected (high -> low)
                //use sqrt of total
                var IAcolor = d3.scaleLinear()
                    .domain([2, 15])
                    .range(['#efffeb', '#125400'])
                console.log(IAcolor)

                //Change the color based on IA array
                svg.selectAll("path")
                    .data(topojson.feature(us, us.objects.states).features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .attr("fill", function (d) {
                        var val = Math.log(Math.sqrt(personsAffectedArray[d.id]))
                        return IAcolor(val)
                    });

                svg.selectAll("text")
                    .data(topojson.feature(us, us.objects.states).features)
                    .enter()
                    .append("text")
                    .attr("x", function (d) {
                        return path.centroid(d)[0];
                    })
                    .attr("y", function (d) {
                        return path.centroid(d)[1];
                    })
                    .attr("font-size", "15px")
                    .attr("font-family", "Courier New")
                    .attr("font-weight", "bold")
                    .text(function (d) {
                        return d.id
                    });

            })
            console.log(BreachTypeSumData)
            /* console.log(personsAffectedArray) */
        });

        /* let BreachTypeSumData = {
            "Hack": 0,
            "UA": 0,
            "Theft": 0,
            "Other": 0,
            "ImD": 0,
            "Loss": 0,
            "Unknown": 0
        } */

    </script>

    <!-- Load the Navbar -->
    <script>
        $("#header").load("navbar.html");
    </script>
</body>